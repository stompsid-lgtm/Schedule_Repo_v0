# Log.md — 開發日誌

## 已解決的問題

### [schedules.json] 排班衝突：同一醫師同時出現在兩家診所（2026-02-18）

**問題**：`schedules.json` 中發現 10 筆衝突（同一醫師、同一日期、同一時段出現在不同診所），涉及 3 位醫師。

#### 蔡馥如：c03 富新骨科 vs c08 正陽骨科

**根本原因**：蔡馥如確實在兩家診所看診。正陽骨科（c08）**週四下午與晚上**是正確的；週四早上只有曾鵬文，蔡馥如的早診是錯誤轉錄。

**修正**（commit `aa7fa74`）：刪除 c08 的週一～週三蔡馥如 sessions（`zy_m1_2`, `zy_m2_2`, `zy_m3_2`, `zy_a5`, `zy_e2`, `zy_e3`）。

**後續修正**（commit `e797329`）：另刪除 c08 週四早診蔡馥如（`zy_m4_2`），保留週四下午/晚上。

**蔡馥如正確班表（本週）**：
- 富新骨科（c03）：週一早診、週三晚診
- 正陽骨科（c08）：週四下午、週四晚診

#### 廖芝晨：c07 土城杏光 vs c19 得揚診所

**根本原因**：廖芝晨確實在兩家診所看診，但班表轉錄時把得揚的班表錯誤複製到土城杏光。對照 CXMS 截圖確認：廖芝晨在土城杏光**只有週一夜間**，其餘時段是劉侑真、朱育葳、莊凱如、李毅康。

**修正**：
- 刪除 c07 的 5 筆錯誤廖芝晨 sessions
- 新增 3 筆正確 sessions（劉侑真 2/24 早上/下午、劉侑真 2/25 夜間）
- 修正 2 筆醫師名稱錯誤（2/25 早上：朱育葳→莊凱如；2/25 下午：劉侑真→李毅康）

#### 悅滿意江：c13 悅滿意永和 vs c14 悅滿意新店

**結論**：這是同一個人在兩個院區，不是錯誤，不需修正。

**Git commit**：`aa7fa74`

---

### [schedules.json] 富新骨科班表錯誤修正（2026-02-18）

**問題**：富新骨科（c03）多筆資料有誤：
1. 2/25（三）早診/下午醫師記錯（李荃↔潘毅軒、蔡馥如↔李荃）
2. 2/26（四）、2/27（五）CXMS 網頁空白，但 JSON 中有資料

**修正**（commit `e797329`）：
- 2/25 早診：李荃 → 潘毅軒
- 2/25 下午：蔡馥如 → 李荃
- 刪除 2/26 下午（`fc_a4`）、2/26 晚上（`fc_e4`）、2/27 早診（`fc_m5`）、2/27 下午（`fc_a5`）、2/27 晚上（`fc_e5`）共 5 筆

**富新骨科修正後班表**：
| 日期 | 早診 | 下午 | 晚上 |
|------|------|------|------|
| 週一 | 蔡馥如 | 李荃 | 潘毅軒 |
| 週二 | 潘毅軒 | 潘毅軒 | 李荃 |
| 週三 | 潘毅軒 | 李荃 | 蔡馥如 |
| 週四～週六 | — | — | — |

---

### [設定頁] Toggle 三態邏輯 Bug（2026-02-18）
**問題**：設定頁的醫師顯示/隱藏 toggle，第二次點擊時行為錯誤——應該「清除 override 回到基礎狀態」，但實際上又再次寫入 override。

**嘗試過**：
- 直接用 `overrides[key] = 'hide'` toggle → 失敗，因為沒有處理「清除」的第三態

**解法**：改成三態邏輯：
1. 無 override（基礎狀態）→ 點擊 → 寫入 `'hide'`（手動隱藏）
2. 有 `'hide'` override → 點擊 → 刪除 key（清除 override，回到基礎）
3. 基礎狀態若本來就是隱藏（黑名單）→ 點擊 → 寫入 `'show'`（強制顯示）

---

### [資料爬取] Facebook 反爬蟲（2026-02-18）
**問題**：部分 FB 診所貼文需要登入才能看到，`fb_snapshot.py` 截圖只拍到登入頁。

**嘗試過**：
- 直接用 Selenium 無頭模式截圖 → 失敗，FB 偵測到 bot 並跳出登入頁

**現行方案**：改為「手動截圖 + `--add-screenshot` 加入」，不再嘗試自動登入 FB。

---

### [資料爬取] CXMS 網站反爬蟲偵測（2026-02-18）
**結果**：8/8 家 CXMS 診所全部可直接爬取，無 Cloudflare，無需 JS 渲染。可放心用 `requests` 直接抓 HTML。

---

### [資料爬取] CXMS 班表 AJAX 動態載入問題（2026-02-18）

**根本原因**：CXMS 所有診所的班表都是透過 AJAX 從 `docsch_ajax.php`（或類似端點）動態載入，舊爬蟲只抓 `hosp.php` 靜態 HTML，完全抓不到班表資料。導致初次轉錄全靠人工，且有大量錯誤。

**影響範圍**：8 家 CXMS 診所（c02/c03/c04/c05/c06/c07/c19/c20）的初始資料均為人工轉錄，存在系統性錯誤。

**系統性修正**（commit `b3b8489`）：用瀏覽器逐一爬取 8 家診所實際班表，對比 JSON 後批次修正：
- **c02 維恩**：週二早診錯誤、週一下午漏一診、週三早診漏，刪週四五空白
- **c04 得安**：週一早診/下午、週二早診/下午、週三下午均有錯，刪週四五空白
- **c05 昌惟**：週一/二/三晚上醫師錯誤，週二下午漏診，刪週四五空白
- **c06 昌禾**：週二下午/晚上、週三早診/下午醫師錯誤，刪週四五空白
- **c07 土城杏光**：刪週四五空白資料
- **c20 力康**：週二/三多筆醫師錯誤及漏診，刪週四五空白
- **c03 富新、c19 得揚**：已在前次修正，本次驗證正確 ✅

**結果**：256 → 239 sessions，所有 CXMS 診所對比網站資料 100% 正確。

**後續對策**：爬蟲需改為直接請求 AJAX 端點（各診所路徑不同，需個別確認），或改用 Selenium 渲染後再解析。

---

## 當前卡關的問題

### [診所篩選] `<select>` 的 `onchange` 在 browser subagent 中不觸發
**現象**：用 browser subagent 測試時，用 ArrowDown + Enter 選擇 `<select>` 選項，`onchange` 事件沒有觸發，filter bar 沒出現。

**影響**：只影響自動化測試，實際在手機/瀏覽器上用手點選是正常的。

**暫不處理**：這是 headless browser 的限制，不影響真實使用者。

---

## 待辦事項

### 資料維護
- [ ] 每週更新 `schedules.json`（參考 `scraper/README.md` 流程）
- [ ] 確認各診所白/黑名單是否需要調整
- [ ] 圖片診所（正陽 c08、悅滿意 c13/c14）每 6 個月複查一次

### 功能改進（未來考慮）
- [ ] 加入 Service Worker 支援離線瀏覽（目前每次開 App 都需要網路）
- [ ] 週視圖加入「本週/下週」快速跳轉
- [ ] 底部資訊卡加入診所電話/地址
- [ ] 多語言支援（目前只有繁體中文）

### 已知限制（不打算修）
- 單一 HTML 檔案，不拆分模組（保持簡單，方便直接編輯）
- 不加 build pipeline（維護成本太高）
- 不做使用者帳號（私人工具，不需要）
