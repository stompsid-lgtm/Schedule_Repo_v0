<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="é–€è¨ºæ—¥æ›†">
  <meta name="theme-color" content="#0d0d0d">
  <title>é–€è¨ºæ—¥æ›†</title>
  <style>
    :root {
      --bg: #0d0d0d;
      --bg2: #1a1a1a;
      --bg3: #252525;
      --bg4: #2e2e2e;
      --border: #2e2e2e;
      --border2: #3a3a3a;
      --text: #f0f0f0;
      --text2: #999;
      --text3: #555;
      --accent: #4d9eff;
      --accent-dim: rgba(77, 158, 255, .15);
      --morning-bg: rgba(255, 200, 50, .06);
      --afternoon-bg: rgba(80, 200, 120, .06);
      --evening-bg: rgba(120, 140, 255, .07);
      --other-bg: rgba(255, 100, 100, .07);
      --ms: #b8860b;
      --as: #2e8b57;
      --es: #4a5ab0;
      --os: #9b2020;
      --slot-w: 34px;
      --hdr-h: 52px;
      --nav-h: 44px;
      --r: 10px;
      --rsm: 6px;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      font-size: 14px;
      color: var(--text);
      background: var(--bg);
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100dvh
    }

    .page {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: hidden
    }

    .page.active {
      display: flex
    }

    /* TOP BAR */
    .tbar {
      height: var(--hdr-h);
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
      flex-shrink: 0;
      z-index: 20
    }

    .tbar h1 {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -.3px
    }

    .tbar-r {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .vtog {
      display: flex;
      background: var(--bg3);
      border-radius: 8px;
      border: 1px solid var(--border);
      overflow: hidden
    }

    .vtog button {
      padding: 5px 11px;
      font-size: 12px;
      font-weight: 600;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text2);
      transition: all .15s;
      line-height: 1
    }

    .vtog button.on {
      background: var(--accent);
      color: #fff;
      border-radius: 7px
    }

    .ibtn {
      width: 34px;
      height: 34px;
      border: none;
      background: var(--bg3);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text2);
      font-size: 16px;
      border: 1px solid var(--border);
      transition: background .15s
    }

    .ibtn:active {
      background: var(--bg4)
    }

    /* NAV BAR */
    .nbar {
      height: var(--nav-h);
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 8px;
      gap: 4px;
      flex-shrink: 0
    }

    .narr {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text2);
      transition: background .12s;
      flex-shrink: 0
    }

    .narr:active {
      background: var(--bg4)
    }

    #nav-title {
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      flex: 1
    }

    .tbtn {
      font-size: 11px;
      font-weight: 600;
      padding: 5px 10px;
      border: 1px solid var(--accent);
      background: transparent;
      color: var(--accent);
      border-radius: 6px;
      cursor: pointer;
      transition: all .15s;
      flex-shrink: 0
    }

    .tbtn:active {
      background: var(--accent-dim)
    }

    /* FILTER BAR */
    #filter-bar {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(77, 158, 255, .08);
      border-bottom: 1px solid rgba(77, 158, 255, .2);
      flex-shrink: 0
    }

    #filter-bar.on {
      display: flex
    }

    #filter-bar-label {
      flex: 1;
      font-size: 12px;
      color: var(--accent);
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    #clear-filter-btn {
      font-size: 11px;
      font-weight: 700;
      padding: 4px 10px;
      border: 1px solid var(--accent);
      background: transparent;
      color: var(--accent);
      border-radius: 6px;
      cursor: pointer;
      flex-shrink: 0;
      transition: background .15s
    }

    #clear-filter-btn:active {
      background: var(--accent-dim)
    }

    /* CLINIC SELECT */
    #clinic-select {
      font-size: 11px;
      font-weight: 600;
      padding: 5px 6px;
      border: 1px solid var(--border2);
      background: var(--bg3);
      color: var(--text2);
      border-radius: 6px;
      cursor: pointer;
      max-width: 80px;
      flex-shrink: 0;
      outline: none;
      -webkit-appearance: none;
      appearance: none
    }

    #clinic-select:focus {
      border-color: var(--accent)
    }

    /* CALENDAR */
    #cw {
      flex: 1;
      overflow: auto;
      -webkit-overflow-scrolling: touch
    }

    #cal {
      display: grid
    }

    .ccorner {
      position: sticky;
      top: 0;
      left: 0;
      z-index: 8;
      background: var(--bg2);
      border-bottom: 1px solid var(--border2);
      border-right: 1px solid var(--border);
      width: var(--slot-w)
    }

    .dhdr {
      position: sticky;
      top: 0;
      z-index: 6;
      background: var(--bg2);
      border-bottom: 1px solid var(--border2);
      border-right: 1px solid var(--border);
      padding: 7px 4px 5px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1px
    }

    .dhdr .wd {
      font-size: 9px;
      font-weight: 700;
      color: var(--text3);
      letter-spacing: .8px
    }

    .dhdr .dn {
      font-size: 17px;
      font-weight: 700;
      color: var(--text);
      line-height: 1;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%
    }

    .dhdr.tod .dn {
      background: var(--accent);
      color: #fff;
      font-size: 14px
    }

    .dhdr .mo {
      font-size: 9px;
      color: var(--text3)
    }

    .slbl {
      position: sticky;
      left: 0;
      z-index: 5;
      background: var(--bg2);
      border-right: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      writing-mode: vertical-rl;
      font-size: 10px;
      font-weight: 700;
      color: var(--text3);
      letter-spacing: 2px;
      min-height: 80px;
      padding: 8px 0;
      width: var(--slot-w)
    }

    .slbl.morning {
      border-left: 2px solid var(--ms)
    }

    .slbl.afternoon {
      border-left: 2px solid var(--as)
    }

    .slbl.evening {
      border-left: 2px solid var(--es)
    }

    .slbl.other {
      border-left: 2px solid var(--os)
    }

    .cc {
      border-right: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      padding: 4px 3px;
      min-height: 80px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3px;
      align-content: start
    }

    .cc.morning {
      background: var(--morning-bg)
    }

    .cc.afternoon {
      background: var(--afternoon-bg)
    }

    .cc.evening {
      background: var(--evening-bg)
    }

    .cc.other {
      background: var(--other-bg)
    }

    .cc.tcol {
      filter: brightness(1.4)
    }

    /* single chip spans full width */
    .cc.solo .chip {
      grid-column: 1/-1
    }

    .chip {
      border-radius: var(--rsm);
      padding: 4px 5px;
      background: var(--bg3);
      border-left: 3px solid transparent;
      cursor: pointer;
      transition: background .12s, opacity .2s, box-shadow .2s;
      min-width: 0;
      overflow: hidden
    }

    .chip:active {
      background: var(--bg4)
    }

    .chip .cn {
      font-size: 11px;
      font-weight: 700;
      line-height: 1.25;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block
    }

    /* Filter highlight states */
    .chip.dimmed {
      opacity: 0.18;
      filter: grayscale(0.7)
    }

    .chip.highlighted {
      box-shadow: 0 0 0 2px var(--accent);
      background: rgba(77, 158, 255, .12)
    }

    .cempty {
      grid-column: 1/-1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text3);
      font-size: 12px;
      padding: 10px 0;
      min-height: 60px
    }

    /* BOTTOM SHEET */
    #ov {
      position: fixed;
      inset: 0;
      z-index: 50;
      background: rgba(0, 0, 0, .6);
      display: none;
      opacity: 0;
      transition: opacity .22s;
      -webkit-backdrop-filter: blur(3px);
      backdrop-filter: blur(3px)
    }

    #ov.on {
      display: block;
      opacity: 1
    }

    #bs {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 51;
      background: var(--bg2);
      border-radius: 18px 18px 0 0;
      border-top: 1px solid var(--border2);
      padding: 0 0 env(safe-area-inset-bottom, 16px);
      transform: translateY(100%);
      transition: transform .28s cubic-bezier(.34, 1.12, .64, 1);
      max-height: 65vh;
      overflow-y: auto
    }

    #bs.on {
      transform: translateY(0)
    }

    .bsh {
      width: 36px;
      height: 4px;
      border-radius: 2px;
      background: var(--border2);
      margin: 10px auto 0
    }

    .bsi {
      padding: 14px 20px 20px
    }

    .bsclin {
      font-size: 11px;
      font-weight: 600;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: .8px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .bsdot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0
    }

    .bsname {
      font-size: 22px;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 14px;
      line-height: 1
    }

    .bsrow {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      padding: 10px 0;
      border-top: 1px solid var(--border)
    }

    .bsicon {
      font-size: 16px;
      flex-shrink: 0;
      width: 22px;
      text-align: center
    }

    .bsbody {
      flex: 1
    }

    .bslbl {
      font-size: 10px;
      color: var(--text3);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .6px;
      margin-bottom: 2px
    }

    .bsval {
      font-size: 14px;
      color: var(--text);
      line-height: 1.5
    }

    /* Filter doctor button in bottom sheet */
    .bs-filter-btn {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      background: rgba(77, 158, 255, .12);
      border: 1px solid rgba(77, 158, 255, .4);
      border-radius: var(--r);
      color: var(--accent);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: background .12s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px
    }

    .bs-filter-btn:active {
      background: rgba(77, 158, 255, .22)
    }

    .bs-filter-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent)
    }

    .bsclose {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      background: var(--bg3);
      border: 1px solid var(--border2);
      border-radius: var(--r);
      color: var(--text2);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background .12s
    }

    .bsclose:active {
      background: var(--bg4)
    }

    /* SETTINGS */
    #page-settings {
      background: var(--bg)
    }

    #slist {
      flex: 1;
      overflow-y: auto;
      padding: 10px 16px 40px;
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .stitle {
      font-size: 11px;
      font-weight: 700;
      color: var(--text3);
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 8px 0 4px
    }

    .sdesc {
      font-size: 11px;
      color: var(--text3);
      margin-bottom: 6px;
      padding: 0 2px;
      line-height: 1.5
    }

    /* Usage guide card */
    .guide-card {
      background: var(--bg2);
      border-radius: var(--r);
      border: 1px solid var(--border);
      padding: 14px 16px;
      margin-bottom: 4px
    }

    .guide-row {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      padding: 7px 0;
      border-bottom: 1px solid var(--border)
    }

    .guide-row:last-child {
      border-bottom: none;
      padding-bottom: 0
    }

    .guide-row:first-child {
      padding-top: 0
    }

    .guide-icon {
      font-size: 16px;
      flex-shrink: 0;
      width: 22px;
      text-align: center;
      margin-top: 1px
    }


    .guide-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 2px
    }

    .guide-desc {
      font-size: 11px;
      color: var(--text3);
      line-height: 1.5
    }

    .scard {
      background: var(--bg2);
      border-radius: var(--r);
      border: 1px solid var(--border);
      overflow: hidden
    }

    .srow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 14px;
      border-bottom: 1px solid var(--border);
      gap: 10px
    }

    .srow:last-child {
      border-bottom: none
    }

    .srl {
      flex: 1;
      min-width: 0
    }

    .srn {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .srs {
      font-size: 11px;
      color: var(--text3);
      margin-top: 1px
    }

    .srr {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0
    }

    .tog {
      width: 44px;
      height: 26px;
      border-radius: 13px;
      background: var(--border2);
      position: relative;
      cursor: pointer;
      transition: background .2s;
      flex-shrink: 0;
      border: none
    }

    .tog.on {
      background: var(--accent)
    }

    .tog::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      top: 3px;
      left: 3px;
      transition: transform .2s;
      box-shadow: 0 1px 4px rgba(0, 0, 0, .3)
    }

    .tog.on::after {
      transform: translateX(18px)
    }

    .cswatch {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid var(--border2);
      flex-shrink: 0
    }

    .sbadge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 700;
      white-space: nowrap
    }

    .sbadge.white {
      background: rgba(77, 158, 255, .2);
      color: var(--accent)
    }

    .sbadge.black {
      background: rgba(255, 100, 100, .2);
      color: #ff8080
    }

    .addrow {
      display: flex;
      gap: 8px;
      padding: 10px 14px;
      background: var(--bg3);
      border-top: 1px solid var(--border)
    }

    .addinp {
      flex: 1;
      background: var(--bg4);
      border: 1px solid var(--border2);
      border-radius: 8px;
      padding: 8px 10px;
      color: var(--text);
      font-size: 13px;
      outline: none
    }

    .addinp::placeholder {
      color: var(--text3)
    }

    .addbtn {
      padding: 8px 14px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap
    }

    /* UPDATE BAR */
    #ubar {
      padding: 3px 14px;
      background: var(--bg2);
      border-top: 1px solid var(--border);
      font-size: 10px;
      color: var(--text3);
      text-align: center;
      flex-shrink: 0
    }

    ::-webkit-scrollbar {
      width: 3px;
      height: 3px
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border2);
      border-radius: 2px
    }

    ::-webkit-scrollbar-track {
      background: transparent
    }

    @media(min-width:600px) {
      #bs {
        max-width: 480px;
        left: 50%;
        right: auto;
        transform: translateX(-50%) translateY(100%)
      }

      #bs.on {
        transform: translateX(-50%) translateY(0)
      }
    }
  </style>
</head>

<body>
  <div id="app">

    <!-- CALENDAR PAGE -->
    <div id="page-cal" class="page active">
      <div class="tbar">
        <h1>ğŸ¥ é–€è¨ºæ—¥æ›†</h1>
        <div class="tbar-r">
          <div class="vtog">
            <button id="b2" class="on" onclick="setView('2day')">2å¤©</button>
            <button id="bw" onclick="setView('week')">é€±</button>
          </div>
          <button class="ibtn" onclick="showPage('settings')">âš™ï¸</button>
        </div>
      </div>
      <div class="nbar">
        <button class="narr" onclick="navigate(-1)">â€¹</button>
        <span id="nav-title"></span>
        <button class="tbtn" onclick="goToday()">å›ä»Šå¤©</button>
        <select id="clinic-select" onchange="onClinicSelectChange(this)" title="ç¯©é¸è¨ºæ‰€">
          <option value="">ç¯©é¸è¨ºæ‰€</option>
        </select>
        <button class="narr" onclick="navigate(1)">â€º</button>
      </div>
      <!-- Filter status bar -->
      <div id="filter-bar">
        <span id="filter-bar-label"></span>
        <button id="clear-filter-btn" onclick="clearFilter()">âœ• å–æ¶ˆç¯©é¸</button>
      </div>
      <div id="cw">
        <div id="cal"></div>
      </div>
      <div id="ubar">è¼‰å…¥ä¸­â€¦</div>
    </div>

    <!-- SETTINGS PAGE -->
    <div id="page-settings" class="page">
      <div class="tbar">
        <button class="ibtn" onclick="showPage('cal')" style="font-size:20px;color:var(--accent)">â†</button>
        <h1>è¨­å®š</h1>
        <div style="width:34px"></div>
      </div>
      <div id="slist"></div>
    </div>

  </div>

  <!-- BOTTOM SHEET -->
  <div id="ov" onclick="closeSheet()"></div>
  <div id="bs">
    <div class="bsh"></div>
    <div class="bsi" id="bsi"></div>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CONSTANTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const PALETTE = ['#4d9eff', '#ff6b6b', '#50c878', '#ffa040', '#c87dff',
      '#ff69b4', '#40c8c8', '#e6c200', '#7daaff', '#ff8c69',
      '#90ee90', '#dda0dd', '#20b2aa', '#cd853f', '#6495ed',
      '#ff7f50', '#98fb98', '#f0e68c', '#b0c4de', '#da70d6',
      '#87ceeb', '#f4a460'];
    const WD = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”'];
    const SLOTS = [
      { key: 'morning', lbl: 'ä¸Šåˆ' },
      { key: 'afternoon', lbl: 'ä¸‹åˆ' },
      { key: 'evening', lbl: 'æ™šä¸Š' },
      { key: 'other', lbl: 'å…¶ä»–' },
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let DATA = null;
    let view = '2day';
    let off = 0;
    // Per-clinic manual overrides stored in localStorage
    let overrides = JSON.parse(localStorage.getItem('cc_overrides') || '{}');
    // Filter state (highlight mode â€” does NOT hide other chips, just dims them)
    let filterDoctor = null;   // doctor name string, or null
    let filterClinic = null;   // clinic id string, or null

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  UTILS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function fmtDate(d) {
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }
    function getMonday(d) {
      const r = new Date(d); r.setHours(0, 0, 0, 0);
      const day = r.getDay(); r.setDate(r.getDate() + (day === 0 ? -6 : 1 - day)); return r;
    }
    function addDays(d, n) { const r = new Date(d); r.setDate(r.getDate() + n); return r; }
    function isToday(d) { return fmtDate(d) === fmtDate(new Date()); }

    function getSlot(s) {
      if (s.slot && s.slot !== 'custom') return s.slot;
      const h = s.time_start ? parseInt(s.time_start, 10) : -1;
      if (h < 0) return 'other';
      if (h < 12) return 'morning';
      if (h >= 13 && h <= 15) return 'afternoon';
      if (h >= 16) return 'evening';
      return 'other';
    }

    function isWeekend(d) { const day = d.getDay(); return day === 0 || day === 6; }

    function addBusinessDays(d, n) {
      const res = new Date(d);
      let count = 0;
      const sign = n >= 0 ? 1 : -1;
      const absN = Math.abs(n);
      while (count < absN) {
        res.setDate(res.getDate() + sign);
        if (!isWeekend(res)) count++;
      }
      return res;
    }

    function getDates() {
      const t = new Date(); t.setHours(0, 0, 0, 0);
      // Ensure start date is a weekday
      while (isWeekend(t)) { t.setDate(t.getDate() + 1); }

      if (view === '2day') {
        const b = addBusinessDays(t, off * 2);
        return [b, addBusinessDays(b, 1)];
      }

      const m = getMonday(t);
      m.setDate(m.getDate() + off * 7);
      // Week view: always Mon-Fri
      return Array.from({ length: 5 }, (_, i) => addDays(m, i));
    }

    function navTitle(dates) {
      if (!dates.length) return '';
      const f = d => `${d.getMonth() + 1}/${d.getDate()}`;
      if (dates.length === 1) return f(dates[0]);
      const a = dates[0], b = dates[dates.length - 1];

      // If same month
      if (a.getMonth() === b.getMonth()) {
        // for 2-day view crossing weekend (Fri, Mon), we might want full ranges
        // but "M/D-D" is fine.
        return `${a.getMonth() + 1}æœˆ ${a.getDate()}â€“${b.getDate()}æ—¥`;
      }
      return `${f(a)} â€“ ${f(b)}`;
    }

    // â”€â”€ Filter logic: whitelist > blacklist > show all â”€â”€
    function shouldShow(doctorName, clinic) {
      if (!clinic) return true;
      const wl = clinic.whitelist || [];
      const bl = clinic.blacklist || [];
      const ov = overrides[clinic.id] || {};
      const extraHidden = ov.extraHidden || [];
      const extraShow = ov.extraShow || [];

      // Manual overrides take highest priority
      if (extraHidden.includes(doctorName)) return false;
      if (extraShow.includes(doctorName)) return true;

      // JSON config
      if (wl.length > 0) return wl.includes(doctorName);
      if (bl.length > 0) return !bl.includes(doctorName);
      return true;
    }

    // Base show without overrides (used for togOverride fix)
    function baseShow(doctorName, clinic) {
      if (!clinic) return true;
      const wl = clinic.whitelist || [];
      const bl = clinic.blacklist || [];
      if (wl.length > 0) return wl.includes(doctorName);
      if (bl.length > 0) return !bl.includes(doctorName);
      return true;
    }

    function saveOverrides() { localStorage.setItem('cc_overrides', JSON.stringify(overrides)); }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FILTER STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function setDoctorFilter(name) {
      filterDoctor = name;
      filterClinic = null;
      // Reset clinic select
      document.getElementById('clinic-select').value = '';
      updateFilterBar();
      render();
    }

    function setClinicFilter(clinicId) {
      filterClinic = clinicId;
      filterDoctor = null;
      updateFilterBar();
      render();
    }

    function clearFilter() {
      filterDoctor = null;
      filterClinic = null;
      document.getElementById('clinic-select').value = '';
      updateFilterBar();
      render();
    }

    function updateFilterBar() {
      const bar = document.getElementById('filter-bar');
      const label = document.getElementById('filter-bar-label');
      if (filterDoctor) {
        bar.classList.add('on');
        label.textContent = `ğŸ” ç¯©é¸é†«å¸«ï¼š${filterDoctor}`;
      } else if (filterClinic) {
        const cl = DATA?.clinics.find(c => c.id === filterClinic);
        bar.classList.add('on');
        label.textContent = `ğŸ” ç¯©é¸è¨ºæ‰€ï¼š${cl?.name || filterClinic}`;
      } else {
        bar.classList.remove('on');
        label.textContent = '';
      }
    }

    function onClinicSelectChange(sel) {
      const val = sel.value;
      if (!val) {
        clearFilter();
      } else {
        setClinicFilter(val);
      }
    }

    function populateClinicSelect() {
      if (!DATA) return;
      const sel = document.getElementById('clinic-select');
      // Keep first option
      while (sel.options.length > 1) sel.remove(1);
      DATA.clinics.forEach(cl => {
        const opt = document.createElement('option');
        opt.value = cl.id;
        opt.textContent = cl.name;
        sel.appendChild(opt);
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  RENDER CALENDAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function render() {
      if (!DATA) return;
      const dates = getDates();
      const cal = document.getElementById('cal');
      const cols = dates.length;
      const minW = cols > 2 ? 105 : 145;
      cal.style.gridTemplateColumns = `var(--slot-w) repeat(${cols},minmax(${minW}px,1fr))`;

      // Determine if any filter is active
      const hasFilter = !!(filterDoctor || filterClinic);

      // lookup: dateStr â†’ slot â†’ [sessions with doctor + clinic]
      const lk = {};
      dates.forEach(d => { lk[fmtDate(d)] = { morning: [], afternoon: [], evening: [], other: [] }; });

      DATA.sessions.forEach(s => {
        if (!lk[s.date]) return;
        const clinic = DATA.clinics.find(c => c.id === s.clinic_id);
        const name = s.doctor_name;
        if (!shouldShow(name, clinic)) return;
        lk[s.date][getSlot(s)].push(s);
      });

      const showSlots = SLOTS.filter(sl =>
        sl.key !== 'other' || dates.some(d => lk[fmtDate(d)].other.length > 0)
      );

      let h = '';
      h += `<div class="ccorner"></div>`;
      dates.forEach(d => {
        const dow = d.getDay(); const wi = dow === 0 ? 6 : dow - 1;
        h += `<div class="dhdr${isToday(d) ? ' tod' : ''}">
      <span class="wd">é€±${WD[wi] ?? ''}</span>
      <span class="dn">${d.getDate()}</span>
      <span class="mo">${d.getMonth() + 1}æœˆ</span>
    </div>`;
      });

      showSlots.forEach(sl => {
        h += `<div class="slbl ${sl.key}">${sl.lbl}</div>`;
        dates.forEach(d => {
          const sessions = lk[fmtDate(d)]?.[sl.key] ?? [];
          const tc = isToday(d) ? ' tcol' : '';
          const soloClass = sessions.length <= 1 ? ' solo' : '';
          h += `<div class="cc ${sl.key}${tc}${soloClass}">`;
          if (!sessions.length) {
            h += `<div class="cempty">â€”</div>`;
          } else {
            sessions.forEach(s => {
              const clinic = DATA.clinics.find(x => x.id === s.clinic_id);
              const color = clinic?.color || '#888';
              const name = s.doctor_name;

              // Determine highlight class
              let hlClass = '';
              if (hasFilter) {
                let isMatch = false;
                if (filterDoctor && name === filterDoctor) isMatch = true;
                if (filterClinic && s.clinic_id === filterClinic) isMatch = true;
                hlClass = isMatch ? ' highlighted' : ' dimmed';
              }

              h += `<div class="chip${hlClass}" style="border-left-color:${color}"
              onclick="openSheet('${s.id}')">
            <span class="cn" style="color:${color}">${name}</span>
          </div>`;
            });
          }
          h += `</div>`;
        });
      });

      cal.innerHTML = h;
      document.getElementById('nav-title').textContent = navTitle(dates);
      const t = DATA.meta?.generated_at
        ? new Date(DATA.meta.generated_at).toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })
        : 'â€”';
      document.getElementById('ubar').textContent = `è³‡æ–™æ›´æ–°ï¼š${t}`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  BOTTOM SHEET
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openSheet(sid) {
      const s = DATA.sessions.find(x => x.id === sid); if (!s) return;
      const clinic = DATA.clinics.find(x => x.id === s.clinic_id);
      const color = clinic?.color || '#888';
      const slotMap = { morning: 'ä¸Šåˆ', afternoon: 'ä¸‹åˆ', evening: 'æ™šä¸Š', other: 'å…¶ä»–', custom: 'è‡ªè¨‚' };

      let rows = `<div class="bsrow">
    <div class="bsicon">ğŸ•</div>
    <div class="bsbody">
      <div class="bslbl">çœ‹è¨ºæ™‚æ®µ</div>
      <div class="bsval">${s.time_label || slotMap[getSlot(s)] || 'â€”'}</div>
    </div>
  </div>
  <div class="bsrow">
    <div class="bsicon">ğŸ¥</div>
    <div class="bsbody">
      <div class="bslbl">è¨ºæ‰€</div>
      <div class="bsval">${clinic?.name || 'â€”'}</div>
    </div>
  </div>
  <div class="bsrow">
    <div class="bsicon">ğŸ“…</div>
    <div class="bsbody">
      <div class="bslbl">æ—¥æœŸ</div>
      <div class="bsval">${s.date}</div>
    </div>
  </div>`;
      if (s.source_note) rows += `<div class="bsrow">
    <div class="bsicon">ğŸ“‹</div>
    <div class="bsbody">
      <div class="bslbl">å‚™è¨»</div>
      <div class="bsval">${s.source_note}</div>
    </div>
  </div>`;

      // Determine if this doctor is currently filtered
      const isFiltered = filterDoctor === s.doctor_name;
      const filterBtnClass = isFiltered ? 'bs-filter-btn active' : 'bs-filter-btn';
      const filterBtnText = isFiltered ? 'âœ“ å·²ç¯©é¸æ­¤é†«å¸«' : 'ğŸ” ç¯©é¸æ­¤é†«å¸«';

      document.getElementById('bsi').innerHTML = `
    <div class="bsclin"><div class="bsdot" style="background:${color}"></div>${clinic?.name || 'â€”'}</div>
    <div class="bsname">${s.doctor_name}</div>
    ${rows}
    <button class="${filterBtnClass}" id="bs-filter-btn"
      onclick="onSheetFilterClick('${s.doctor_name.replace(/'/g, "\\'")}')">
      ${filterBtnText}
    </button>
    <button class="bsclose" onclick="closeSheet()">é—œé–‰</button>`;

      document.getElementById('ov').classList.add('on');
      document.getElementById('bs').classList.add('on');
      document.body.style.overflow = 'hidden';
    }

    function onSheetFilterClick(doctorName) {
      if (filterDoctor === doctorName) {
        // Toggle off
        clearFilter();
        closeSheet();
      } else {
        setDoctorFilter(doctorName);
        closeSheet();
      }
    }

    function closeSheet() {
      document.getElementById('ov').classList.remove('on');
      document.getElementById('bs').classList.remove('on');
      document.body.style.overflow = '';
    }
    (() => {
      let sy = 0; const bs = document.getElementById('bs');
      bs.addEventListener('touchstart', e => { sy = e.touches[0].clientY; }, { passive: true });
      bs.addEventListener('touchend', e => { if (e.changedTouches[0].clientY - sy > 60) closeSheet(); }, { passive: true });
    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SETTINGS PAGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderSettings() {
      if (!DATA) { document.getElementById('slist').innerHTML = '<div style="padding:20px;color:var(--text3)">å°šæœªè¼‰å…¥è³‡æ–™</div>'; return; }
      const list = document.getElementById('slist');
      let h = '';

      // â”€â”€ Usage Guide â”€â”€
      h += `<div class="stitle">ä½¿ç”¨èªªæ˜</div>
  <div class="guide-card">
    <div class="guide-row">
      <div class="guide-icon">ğŸ”</div>
      <div class="guide-body">
        <div class="guide-title">ç¯©é¸é†«å¸«</div>
        <div class="guide-desc">é»æ“Šæ—¥æ›†ä¸Šä»»ä¸€é†«å¸«åç¨±ï¼Œåœ¨è³‡è¨Šé é»ã€Œç¯©é¸æ­¤é†«å¸«ã€ï¼Œä¸»é é¢æœƒé†’ç›®é¡¯ç¤ºè©²é†«å¸«ï¼Œå…¶ä»–è®Šæš—ã€‚</div>
      </div>
    </div>
    <div class="guide-row">
      <div class="guide-icon">ğŸ¥</div>
      <div class="guide-body">
        <div class="guide-title">ç¯©é¸è¨ºæ‰€</div>
        <div class="guide-desc">åœ¨æ—¥æ›†é ä¸Šæ–¹çš„ã€Œç¯©é¸è¨ºæ‰€ã€ä¸‹æ‹‰é¸å–®é¸å–è¨ºæ‰€ï¼Œè©²è¨ºæ‰€æ‰€æœ‰é†«å¸«æœƒé†’ç›®é¡¯ç¤ºã€‚</div>
      </div>
    </div>
    <div class="guide-row">
      <div class="guide-icon">âœ•</div>
      <div class="guide-body">
        <div class="guide-title">å–æ¶ˆç¯©é¸</div>
        <div class="guide-desc">é»æ“Šç¯©é¸ç‹€æ…‹åˆ—ä¸Šçš„ã€Œâœ• å–æ¶ˆç¯©é¸ã€ï¼Œæˆ–å†æ¬¡é»æ“Šå·²ç¯©é¸çš„é†«å¸«ï¼Œå³å¯å–æ¶ˆç¯©é¸ã€‚</div>
      </div>
    </div>
    <div class="guide-row">
      <div class="guide-icon">ğŸ‘</div>
      <div class="guide-body">
        <div class="guide-title">é¡¯ç¤º / éš±è—é†«å¸«</div>
        <div class="guide-desc">åœ¨ä¸‹æ–¹ã€Œè¨ºæ‰€ç¯©é¸è¨­å®šã€ä¸­ï¼Œå¯ç”¨é–‹é—œæ§åˆ¶å„è¨ºæ‰€é†«å¸«çš„é¡¯ç¤ºã€‚ç™½åå–®/é»‘åå–®ä¾†è‡ªè³‡æ–™è¨­å®šï¼Œæ‰‹å‹•è¦†å¯«å„ªå…ˆã€‚</div>
      </div>
    </div>
    <div class="guide-row">
      <div class="guide-icon">â†”ï¸</div>
      <div class="guide-body">
        <div class="guide-title">åˆ‡æ›æ—¥æœŸ</div>
        <div class="guide-desc">å·¦å³æ»‘å‹•æ—¥æ›†å¯åˆ‡æ›æ—¥æœŸï¼›é»ã€Œå›ä»Šå¤©ã€å›åˆ°ä»Šæ—¥ï¼›é ‚éƒ¨å¯åˆ‡æ›ã€Œ2å¤©ã€æˆ–ã€Œé€±ã€è¦–åœ–ã€‚</div>
      </div>
    </div>
    <div class="guide-row">
      <div class="guide-icon">ğŸ”„</div>
      <div class="guide-body">
        <div class="guide-title">æ›´æ–°è³‡æ–™</div>
        <div class="guide-desc">åœ¨æ—¥æ›†é å‘ä¸‹æ‹‰ï¼ˆPull to Refreshï¼‰å¯é‡æ–°è¼‰å…¥æœ€æ–°ç­è¡¨è³‡æ–™ã€‚</div>
      </div>
    </div>
  </div>`;

      // â”€â”€ Clinic filter settings â”€â”€
      h += `<div class="stitle" style="margin-top:8px">è¨ºæ‰€ç¯©é¸è¨­å®š</div>
  <div class="sdesc">å„è¨ºæ‰€çš„ç™½/é»‘åå–®ä¾†è‡ªè³‡æ–™ä¾†æºè¨­å®šã€‚ä½ å¯ä»¥åœ¨é€™è£¡è¿½åŠ é¡å¤–çš„é¡¯ç¤º/éš±è—ï¼Œå„ªå…ˆæ–¼è³‡æ–™ä¾†æºè¨­å®šã€‚</div>`;

      DATA.clinics.forEach(cl => {
        const wl = cl.whitelist || [];
        const bl = cl.blacklist || [];
        const ov = overrides[cl.id] || {};
        const extraH = ov.extraHidden || [];
        const extraS = ov.extraShow || [];

        // Doctors seen in sessions for this clinic
        const docNames = [...new Set(
          DATA.sessions.filter(s => s.clinic_id === cl.id).map(s => s.doctor_name)
        )];

        let badge = '';
        if (wl.length) badge = `<span class="sbadge white">ç™½åå–®${wl.length}</span>`;
        else if (bl.length) badge = `<span class="sbadge black">é»‘åå–®${bl.length}</span>`;

        h += `<div class="stitle" style="margin-top:4px">${cl.name} ${badge}</div>
    <div class="scard">`;

        docNames.forEach(name => {
          const show = shouldShow(name, cl);
          const isOverridden = extraH.includes(name) || extraS.includes(name);
          h += `<div class="srow">
        <div class="srl">
          <div class="srn">${name}</div>
          ${isOverridden ? '<div class="srs">æ‰‹å‹•è¦†å¯«</div>' : ''}
        </div>
        <div class="srr">
          <div class="cswatch" style="background:${cl.color}"></div>
          <button class="tog${show ? ' on' : ''}"
            onclick="togOverride('${cl.id}','${name.replace(/'/g, "\\'")}',this)"></button>
        </div>
      </div>`;
        });

        // Add extra hidden entry
        h += `<div class="addrow">
      <input class="addinp" id="ai_${cl.id}" placeholder="æ‰‹å‹•éš±è—å§“åâ€¦"
        onkeydown="if(event.key==='Enter')addExtraHidden('${cl.id}')">
      <button class="addbtn" onclick="addExtraHidden('${cl.id}')">éš±è—</button>
    </div></div>`;
      });

      list.innerHTML = h;
    }

    function togOverride(clinicId, name, btn) {
      if (!overrides[clinicId]) overrides[clinicId] = { extraHidden: [], extraShow: [] };
      const ov = overrides[clinicId];
      const clinic = DATA.clinics.find(c => c.id === clinicId);

      const inHidden = ov.extraHidden.includes(name);
      const inShow = ov.extraShow.includes(name);

      if (inHidden || inShow) {
        // Currently overriding â†’ clear override, return to base state
        ov.extraHidden = ov.extraHidden.filter(n => n !== name);
        ov.extraShow = ov.extraShow.filter(n => n !== name);
        // Reflect base state on button
        btn.classList.toggle('on', baseShow(name, clinic));
      } else {
        // No override â†’ toggle from current effective state (= base state)
        const currentlyShowing = baseShow(name, clinic);
        if (currentlyShowing) {
          // Showing â†’ hide
          ov.extraHidden.push(name);
          btn.classList.remove('on');
        } else {
          // Hidden â†’ show
          ov.extraShow.push(name);
          btn.classList.add('on');
        }
      }

      saveOverrides(); render();
    }

    function addExtraHidden(clinicId) {
      const inp = document.getElementById(`ai_${clinicId}`);
      const name = inp.value.trim(); if (!name) return;
      if (!overrides[clinicId]) overrides[clinicId] = { extraHidden: [], extraShow: [] };
      if (!overrides[clinicId].extraHidden.includes(name))
        overrides[clinicId].extraHidden.push(name);
      saveOverrides(); inp.value = '';
      renderSettings(); render();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function setView(v) {
      view = v; off = 0;
      document.getElementById('b2').classList.toggle('on', v === '2day');
      document.getElementById('bw').classList.toggle('on', v === 'week');
      render();
    }
    function navigate(dir) { off += dir; render(); }
    function goToday() { off = 0; render(); }
    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + id).classList.add('active');
      if (id === 'settings') renderSettings();
      if (id === 'cal') render();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SWIPE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    (() => {
      let sx = 0, sy = 0; const w = document.getElementById('cw');
      w.addEventListener('touchstart', e => { sx = e.touches[0].clientX; sy = e.touches[0].clientY; }, { passive: true });
      w.addEventListener('touchend', e => {
        const dx = e.changedTouches[0].clientX - sx, dy = e.changedTouches[0].clientY - sy;
        if (Math.abs(dx) > 55 && Math.abs(dx) > Math.abs(dy) * 1.4) navigate(dx < 0 ? 1 : -1);
      }, { passive: true });
    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  DATA LOAD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadData() {
      try {
        const r = await fetch('./schedules.json?v=' + Date.now(), { cache: 'no-store' });
        if (!r.ok) throw 0;
        const j = await r.json();
        j.clinics.forEach((c, i) => { if (!c.color) c.color = PALETTE[i % PALETTE.length]; });
        DATA = j;
        populateClinicSelect();
        render();
      } catch {
        // Inline fallback sample (minimal)
        DATA = {
          meta: { generated_at: new Date().toISOString(), version: '1.0' },
          clinics: [{ id: 'demo', name: 'ç¯„ä¾‹è¨ºæ‰€', color: '#4d9eff', whitelist: [], blacklist: [] }],
          sessions: []
        };
        populateClinicSelect();
        render();
      }
    }

    // pull-to-refresh
    (() => {
      let ps = 0; const w = document.getElementById('cw');
      w.addEventListener('touchstart', e => { if (w.scrollTop === 0) ps = e.touches[0].clientY; }, { passive: true });
      w.addEventListener('touchend', e => {
        if (ps > 0 && e.changedTouches[0].clientY - ps > 72 && w.scrollTop === 0) {
          document.getElementById('ubar').textContent = 'æ›´æ–°ä¸­â€¦'; loadData();
        } ps = 0;
      }, { passive: true });
    })();

    loadData();
  </script>
</body>

</html>